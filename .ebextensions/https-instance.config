# (!) Based on : https://gist.github.com/tony-gutierrez/198988c34e020af0192bab543d35a62a
# Dont forget to set the env variable "CERTDOMAIN" and "EMAIL"
# Also note that this config is using the LetsEncrypt staging server, remove the flag when ready!
files:

  # The Nginx config forces https, and is meant as an example only. 
  /etc/nginx/conf.d/000_http_redirect_custom.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
        listen 8080;
        return 301 https://$host$request_uri;
      }
  # Allow verification to perform the challenge
  /etc/nginx/conf.d/allow_LetsEncrypt_verification.conf:
    mode: "000644"
    owner: root
    group: root
    content: |
      server {
        listen 8080;
        location ~ /.well-known/  {
            root /var/www/acme-challenge/;
        }
      }    
  # The Nginx config forces https, and is meant as an example only. 
  /etc/nginx/conf.d/https_custom.pre:
    mode: "000644"
    owner: root
    group: root
    content: |
      # HTTPS server
      server {
        listen       443 default ssl;
        server_name  localhost;
        error_page  497 https://$host$request_uri;
        
        ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;
        ssl_session_timeout  5m;
        ssl_protocols  TLSv1.1 TLSv1.2;
        ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
        ssl_prefer_server_ciphers   on;
        if ($ssl_protocol = "") {
          rewrite ^ https://$host$request_uri? permanent;
        }
        location ~ ^/(lib/|img/) {
          root /var/app/current/public;
          access_log off;
        }
        location / {
            proxy_pass  http://nodejs;
            proxy_set_header   Connection "";
            proxy_http_version 1.1;
            proxy_set_header        Host            $host;
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Upgrade         $http_upgrade;
            proxy_set_header        Connection      "upgrade";
        }
      }
packages: 
  yum:
    amazon-linux-extras: []

container_commands:
  10_installepel:
    command: "sudo amazon-linux-extras install epel -y"
  20_installcertbot:
    command: "wget https://dl.eff.org/certbot-auto;chmod a+x certbot-auto"
  30_createwebrootpath:
    command: "sudo mkdir /var/www/acme-challenge/"  
  40_getcertwebrootmode:
    command: "sudo ./certbot-auto certonly --debug --non-interactive --email bensmith87@gmail.com --agree-tos --authenticator webroot --webroot-path /var/www/acme-challenge --domains iocool.hActar.com --keep-until-expiring --installer nginx"
  50_link:
    command: "sudo ln -sf /etc/letsencrypt/live/iocool.h4ctar.com /etc/letsencrypt/live/ebcert"
  60_config:
    command: "sudo mv /etc/nginx/conf.d/https_custom.pre /etc/nginx/conf.d/https_custom.conf"
    
# files:
#   /etc/nginx/conf.d/https.conf:
#     mode: "000644"
#     owner: root
#     group: root
#     content: |
#       # HTTPS server

#       server {
#           listen       443;
#           server_name  localhost;
          
#           ssl                  on;
#           ssl_certificate      /etc/pki/tls/certs/server.crt;
#           ssl_certificate_key  /etc/pki/tls/certs/server.key;
          
#           ssl_session_timeout  5m;
          
#           ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
#           ssl_prefer_server_ciphers   on;
          
#           location / {
#               proxy_pass  http://nodejs;
#               proxy_set_header   Connection "";
#               proxy_http_version 1.1;
#               proxy_set_header        Host            $host;
#               proxy_set_header        X-Real-IP       $remote_addr;
#               proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
#               proxy_set_header        X-Forwarded-Proto https;
#           }
#       }
      
#   /etc/pki/tls/certs/server.crt:
#     mode: "000400"
#     owner: root
#     group: root
#     content: |
#       -----BEGIN CERTIFICATE-----
#       MIIFjzCCA3egAwIBAgIUK3GRZmEVpTINfKWcL8GqCch8uc4wDQYJKoZIhvcNAQEL
#       BQAwVzELMAkGA1UEBhMCQVUxETAPBgNVBAgMCFZpY3RvcmlhMRIwEAYDVQQHDAlN
#       ZWxib3VybmUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0y
#       MTAxMjkyMTU5MDRaFw0yMjAxMjkyMTU5MDRaMFcxCzAJBgNVBAYTAkFVMREwDwYD
#       VQQIDAhWaWN0b3JpYTESMBAGA1UEBwwJTWVsYm91cm5lMSEwHwYDVQQKDBhJbnRl
#       cm5ldCBXaWRnaXRzIFB0eSBMdGQwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIK
#       AoICAQCwYv3sXf+NdUlFUkmI6ufhHJRC/uOCZaTIPErWEo2hD1TEiZDXAhDtKUnI
#       VciaYOEkwQc9yEuPyBB4VeEKBQ3gBTXUXTWGT9VfH4OZ/P8BpbtHRouPT2MiMoLX
#       L6fV4gaQmlxA4GkVnf8kcZrJySh3hL1VV6jpZ1bSoW77CViu2OsuEt9yBj0utaHb
#       ZwO6Iq1sr48DDpQyRUzx0qqc2wmeBKL8AVPVJuuyOWlDn8csv/DKhg/kxTOjw4iQ
#       35X0rud2uoLGtwle5C3nX/9g1AIAS64L95HPAG0U6sFEfBTFFy6TBaLwEz63louR
#       Ymt1FF3KulAlCWjl01DTBmTvu4RZTuuBMCPpLMlAhw2iQi53OXByBuhzjdZyulMn
#       WdgeWivVJTt+N0AWl8jNJ0d5LbdXX4zvYZYwV6GNJRHvoA9aRsml/a0FOPR6gYDW
#       IT3NvSSuhzv32ZDsNsCQDBD38QdBzoEvr5hdelj7tThj1MO5A/hKI+KF0zT4KBqm
#       +bmI/D/v4M7RRIAN2+3vWNWUSKBVvr4lqs7+8u4ddcirQuZnbaTizpOW3Iq6G543
#       FUqetKfPE5tOaKY+XQZwloCTIOJYZJPeAIlmX9AMZyyyQMiwWtFkjfrL/eSxBztg
#       A3uWvgl4LAcRvLonL1X449BwTUKO0Pyy1H7hccRC4mLgTZ+kTwIDAQABo1MwUTAd
#       BgNVHQ4EFgQUrV4bniuAdRuFwY0J8YAZsyfy0WowHwYDVR0jBBgwFoAUrV4bniuA
#       dRuFwY0J8YAZsyfy0WowDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOC
#       AgEAbDXO9pnWVsOgRn/LmrjXh770LpL9DGbCZ/xWpAWq6IFXEKejD5Ud04g1kUvf
#       cu+vQVLqIrNIShGTDs+ZXsBHT/K6FEY1Mhp4nb4pbhGk98aAr6bNzSXVPY56On33
#       Y5DloABooeZrEoq4Patsd+ZMrDe8BV9BkTNOf1kQ/QISzZ1D89GNC/v3e2n021kV
#       fC809ZX+KkRX9RSmr7T1+m0wx/zw4mtuTploS/HdGb867BYeyL0s0dolugRut49K
#       wgeM2SZ9upu3mMnTxSomVZN4EmxCcxWxBdS2QQHDxxHUvMPaFpdMYey+PLQFPvht
#       oVcPNBT+C+rc9mdDcz8w67C3gF3jF5k2JgLrh5qbEy5GENeNblzZ5PlpXf6Lr7rB
#       X8LsJ2ylUjllXr4NarcBI0t+rae81FH9wPjEOCQYjEukdhSETY0KHPV7miKdcMnY
#       xR6AD7s9yxoDiCvFfkM9pyKhEYho+NibXmO2atMwybn+I7C4KcKTzLKbrYYseo5n
#       a545Mlq3xPxm2Lf4lE3O950rsD7IcD02QP39oRX6VeMDv2tdBBRUa2wSzHyjAu3s
#       EFhGxYuci41IAz2+QpjnQE7EsDIfvMzhdLnJk/8I7HtN4FgDFk1PjQB6xCAWjDbT
#       W0CxJVxreZHX6hjxQzHqIHvWJXPrMvUuaTqwcEfftWVauDI=
#       -----END CERTIFICATE-----
      
#   /etc/pki/tls/certs/server.key:
#     mode: "000400"
#     owner: root
#     group: root
#     content: |
#       -----BEGIN RSA PRIVATE KEY-----
#       MIIJQgIBADANBgkqhkiG9w0BAQEFAASCCSwwggkoAgEAAoICAQCwYv3sXf+NdUlF
#       UkmI6ufhHJRC/uOCZaTIPErWEo2hD1TEiZDXAhDtKUnIVciaYOEkwQc9yEuPyBB4
#       VeEKBQ3gBTXUXTWGT9VfH4OZ/P8BpbtHRouPT2MiMoLXL6fV4gaQmlxA4GkVnf8k
#       cZrJySh3hL1VV6jpZ1bSoW77CViu2OsuEt9yBj0utaHbZwO6Iq1sr48DDpQyRUzx
#       0qqc2wmeBKL8AVPVJuuyOWlDn8csv/DKhg/kxTOjw4iQ35X0rud2uoLGtwle5C3n
#       X/9g1AIAS64L95HPAG0U6sFEfBTFFy6TBaLwEz63louRYmt1FF3KulAlCWjl01DT
#       BmTvu4RZTuuBMCPpLMlAhw2iQi53OXByBuhzjdZyulMnWdgeWivVJTt+N0AWl8jN
#       J0d5LbdXX4zvYZYwV6GNJRHvoA9aRsml/a0FOPR6gYDWIT3NvSSuhzv32ZDsNsCQ
#       DBD38QdBzoEvr5hdelj7tThj1MO5A/hKI+KF0zT4KBqm+bmI/D/v4M7RRIAN2+3v
#       WNWUSKBVvr4lqs7+8u4ddcirQuZnbaTizpOW3Iq6G543FUqetKfPE5tOaKY+XQZw
#       loCTIOJYZJPeAIlmX9AMZyyyQMiwWtFkjfrL/eSxBztgA3uWvgl4LAcRvLonL1X4
#       49BwTUKO0Pyy1H7hccRC4mLgTZ+kTwIDAQABAoICABY08Fkg4HqzyHzExmNJh9YM
#       nhHtO0GAgIWBKb7X6SLc5kQ0OZsINI9XQmXJfw8IoW/aKYo6vGCmxIQR89oqFrwc
#       i9FnxsRZKrjmI9BwTL6tWe24UPvC9+0nRNfItS21XjQ4auL0HebN1ICHGQDMpZ6e
#       hKPI/IgeLY0pK+rJG3Qv9TQAxkb5yBwoW+9egdaeZQ0o8S1mWXwWw4AykK5c2VIe
#       rVJi7GYKl2QB3GHaLN5ScANfa4LW3RCCHqB2tc9vcc693pccFj7vJWRa7rEHIBVf
#       cdMp4R6ZpCIdCCYSJR9HMuLps8Db+2prtrigFn1QChrq6AoxrBY7S5K13GFeT2Ql
#       erAG5BMDiYlfUGIKeeu1pQ8OadJJQpGzF2127ifq88tkguWE9UJ24Yg4UCRg3FhD
#       5xsVXDIr57Jd1FkJdANgz9W1uegrCrFOe12CMA4inzFVUy13lOwiwDwwXuTu7r0Y
#       0CvRjbRsN1v0rtRZ4EXLVBeq1pwbKItVp3fzPH/qnK5v3qxM2k2YPAUD8ybTZcVa
#       vyLWAc4iDoKmIF0I2+2CYaGv1lbLZ1HR96PFVYIJsfAd+fRZElmKHTrQfwUEUdFZ
#       0HgVlCp0n6rU1yn2QytdhRw6UHet0DYUHheB+qZpoQ3cZzhSGOOyBRMIFqk/279D
#       ESlNJqHNmnW/jYGcWqFJAoIBAQDfrz9EHki8WAlE66WPH+f/iPUqWqyBPvNd+O5v
#       6k69sFvcIm4DGetNGmxnGnZIfia1ki22xbeCenlr/9RsSh8jRhhp6bbHFlIjw8sT
#       baL2XbRFhQNG9HxTWSViJuIPjFMKZ6XIthqWIZod2yupmaWPbTa0k6fAw33pZIsK
#       RCS/0jH4dJNNlDTNzy9zUuuCUq9uckyGgk4y8azOrAgWyiXlHfp4rzHSMQeJ5PCk
#       TivgaNastlmf8a33v0zmdBVLy3qobVgOOMQIoHORuKMNePxN0rbyiuprqPIWNexT
#       CFJejuhbh39ty+vxl20ldpMuzuVuLcQFo3Gr5IQ+49+oXvSbAoIBAQDJ3nrGkd6g
#       431KNQ6y/vp3p31AD0qpR8Ky6ZwYM4hHIyForIgQUf8bBkXi8gImkuo53n3kDLWE
#       dOoJt7L1j4eAHxqbQJBYxYr2jeoGSYhssnB7mCcHgctFh4fvGdtevpnEZtZULJIS
#       2yJLumQcgB9xoVplB5np9uhKOnMZHP4ACFCFn2UajVO/mpmMdYLP5y07ZnNurmtw
#       4SVU5CIQX7I+PrzaUAmFJl9owSIMS91uE4n7KwEJ5sbtBrMR4XEZ2WmtE8FcYxAW
#       hdYwRKgt2LpjytczWjmNxNsCo5sXPH46kt8StNpHseQnCj/BJyfoZ1cj73ffpQR5
#       0d1qpcfXGthdAoIBAQCWhJKJ/+bp9kOmgPtTKCExLrPq4EEcZ4PURGIOJRj/Q+FM
#       bE6i/5n6tEEl0ASwG1No8wiX6MvnnQp/xhLnG6mATva2rnIz3a1AK8xHMotqRPu9
#       nBfsczAF1gL13TxZQg/O/JfuS7vwMoRGeukSozVpIhChyoojiGj92I5HRjuEaKj/
#       i1Jj7crqgvRnIfEgLQunwnoEOULtvPqPx+tZioWde2LEOv/HdP6hp9DWf1O/Gkz6
#       w2nj2vk5sRzKJmr+KdpL4+hRCZnARFgAQsJVmogMxjIdW6UK9RCSKY7xALSMtJVe
#       ofr5ozMNytvDTdsUsFxqm5lAQg+Hn6ntt+EUp3DpAoIBAECl2zPUazOjJvCo5Tg1
#       qAjBvr7RJtvne1bIsZCekDoX6g8XkcuINuZ0r9TqI/4udoxp0G9EEq2Es57BEbLK
#       cF57l424s4F6YfJrqFKzIdmNm7A5HeatjmeJ6+KKqVJCQARB2snCLFWVj/ooiv8F
#       mQxO3CAWuxfOVr3O0iVsv3tLLl5cmYhTUkq+PAZba7UhF786JCWB/i58K/Rvyujr
#       fK2qcdiIYUQe8dceYsUFVrh10W56ay68lWA7EQXc6NeaZNlkxjvMDc7otZtnoWRt
#       T+O9hgWQE3ZvYKQLuRNL8DDZ8E6RVIY5VhOamKhG3eTzk1iSzBT3R+OrbflFdiZR
#       FpECggEALN0+KIXusOQQq77FE0af5vnSQdfG/NOcE+Nu6r/3UZBhffZDEoIOdVVn
#       t88WS7Dhl6zOsGUlrI8wgNvmVzwtWGj8+T64ZwPuXehvxb6CYRRmxdqYak7Ggq0b
#       r1nCwcIGb9tb1gtfZPUwOMef0Pscd2Y5ojuyQof/KogJiQ/R5K7Nxpupx1TmgHy4
#       1X+6eTp5mek7PZoAHEQKSOZ6BBI2TLG28uOY2D3od9hB3CPeENTjLtsOL2hva6i/
#       5ROQe9LatJfBqz1cHoYHkEPIbC6E1qcGbhS5AiY0dLOh1wOu1hYej182uiW998tA
#       jEJmLtlCRqKIm3toUCJxoVwDmzqvWA==
#       -----END RSA PRIVATE KEY-----
